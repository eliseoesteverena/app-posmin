<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Auth - Login</title><link rel="stylesheet" href="m.css"><style>body{min-height:100vh;display:flex;align-items:center;justify-content:center}.error{color:#dc2626;font-size:var(--font-sm);margin-top:var(--space-1)}.link{color:var(--color-primary);cursor:pointer;font-size:var(--font-sm);text-decoration:underline}.link:hover{color:var(--color-primary-dark)}</style></head><body><div id="app"></div><script type="module">import{el}from'./mount.js';const API_BASE=window.location.hostname.includes("localhost")?"http://localhost:8787":"https://posmin-auth-service.eliseo050595.workers.dev";let authState={access:null,refresh:null,user:null};function getStoredRefresh(){return localStorage.getItem("refresh_token")}function setStoredRefresh(e){e?localStorage.setItem("refresh_token",e):localStorage.removeItem("refresh_token")}async function apiCall(e,t="GET",r=null){const a={method:t,headers:{"Content-Type":"application/json"}};authState.access&&(a.headers.Authorization=`Bearer ${authState.access}`),r&&(a.body=JSON.stringify(r));const s=await fetch(`${API_BASE}${e}`,a);if(!s.ok){const e=await s.json().catch((()=>({error:"Error desconocido"})));throw new Error(e.error||e.message||"Error en la petici√≥n")}return s.json()}async function register(e,t,r){return await apiCall("/register","POST",{email:e,password:t,company_name:r})}async function login(e,t){console.log("üîê Intentando login...");const r=await apiCall("/login","POST",{email:e,password:t});console.log("‚úÖ Login exitoso:",r);authState={access:r.accessToken,refresh:r.refreshToken,user:r.user};setStoredRefresh(r.refreshToken);console.log("üíæ Refresh token guardado:",localStorage.getItem("refresh_token"));await new Promise((e=>setTimeout(e,100)));return r}async function refreshToken(){const e=getStoredRefresh();if(!e)throw new Error("No hay refresh token");console.log("üîÑ Refrescando token...");const t=await apiCall("/refresh","POST",{refresh_token:e});console.log("‚úÖ Token refrescado");authState.access=t.accessToken;authState.refresh=t.refreshToken;setStoredRefresh(t.refreshToken);return t}async function logout(){try{await apiCall("/logout","POST")}catch(e){console.error("Error al hacer logout:",e)}finally{authState={access:null,refresh:null,user:null},setStoredRefresh(null),window.location.replace("index.html")}}async function checkAuth(){const e=getStoredRefresh();if(!e)return!1;try{await refreshToken();console.log("‚úÖ Auth v√°lida, redirigiendo a dashboard");window.location.replace("dashboard.html");return!0}catch(t){console.error("‚ùå Error en checkAuth:",t);authState={access:null,refresh:null,user:null};setStoredRefresh(null);return!1}}function renderLogin(){const e=document.getElementById("app");e.innerHTML="";let t="";const r=el("div",{style:{backgroundColor:"var(--color-white)",padding:"var(--space-8)",borderRadius:"var(--radius-lg)",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",maxWidth:"400px",width:"100%"}},[el("h1",{style:{fontSize:"var(--font-3xl)",fontWeight:"700",marginBottom:"var(--space-2)",textAlign:"center",color:"var(--color-primary)"}},"Iniciar Sesi√≥n"),el("p",{style:{textAlign:"center",color:"var(--color-gray-500)",marginBottom:"var(--space-6)",fontSize:"var(--font-sm)"}},"Accede a tu cuenta"),el("form",{id:"loginForm",onsubmit:async r=>{r.preventDefault();const a=new FormData(r.target),s=a.get("email"),n=a.get("password");if(!s||!n)return void(t="Email y contrase√±a son requeridos",o());const i=document.querySelector("button[type=submit]");i.disabled=!0,i.textContent="Iniciando...";try{await login(s,n);console.log("üöÄ Redirigiendo a dashboard...");await new Promise((e=>setTimeout(e,100)));window.location.replace("dashboard.html")}catch(e){t=e.message,o(),i.disabled=!1,i.textContent="Iniciar Sesi√≥n"}}},[el("div",{style:{marginBottom:"var(--space-4)"}},[el("label",{for:"email"},"Email"),el("input",{type:"email",id:"email",name:"email",placeholder:"tu@email.com",required:!0,autocomplete:"email"})]),el("div",{style:{marginBottom:"var(--space-4)"}},[el("label",{for:"password"},"Contrase√±a"),el("input",{type:"password",id:"password",name:"password",placeholder:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢",required:!0,autocomplete:"current-password"})]),el("div",{id:"errorMsg"}),el("button",{type:"submit"},"Iniciar Sesi√≥n")]),el("div",{style:{marginTop:"var(--space-4)",textAlign:"center"}},[el("span",{style:{fontSize:"var(--font-sm)",color:"var(--color-gray-500)"}},"¬øNo tienes cuenta? "),el("span",{className:"link",onclick:()=>renderRegister()},"Reg√≠strate")])]);function o(){const e=document.getElementById("errorMsg");e.innerHTML="",t&&(e.className="error",e.textContent=t)}e.appendChild(r),o()}function renderRegister(){const e=document.getElementById("app");e.innerHTML="";let t="";const r=el("div",{style:{backgroundColor:"var(--color-white)",padding:"var(--space-8)",borderRadius:"var(--radius-lg)",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",maxWidth:"400px",width:"100%"}},[el("h1",{style:{fontSize:"var(--font-3xl)",fontWeight:"700",marginBottom:"var(--space-2)",textAlign:"center",color:"var(--color-primary)"}},"Crear Cuenta"),el("p",{style:{textAlign:"center",color:"var(--color-gray-500)",marginBottom:"var(--space-6)",fontSize:"var(--font-sm)"}},"Reg√≠strate para comenzar"),el("form",{id:"registerForm",onsubmit:async r=>{r.preventDefault();const a=new FormData(r.target),s=a.get("email"),n=a.get("password"),i=a.get("company_name");if(!s||!n||!i)return void(t="Todos los campos son requeridos",o());if(n.length<8)return void(t="La contrase√±a debe tener al menos 8 caracteres",o());const l=document.querySelector("button[type=submit]");l.disabled=!0,l.textContent="Registrando...";try{await register(s,n,i),l.textContent="Iniciando sesi√≥n...",await login(s,n);console.log("üöÄ Redirigiendo a dashboard...");await new Promise((e=>setTimeout(e,100)));window.location.replace("dashboard.html")}catch(e){t=e.message,o(),l.disabled=!1,l.textContent="Crear Cuenta"}}},[el("div",{style:{marginBottom:"var(--space-4)"}},[el("label",{for:"company_name"},"Nombre del Negocio"),el("input",{type:"text",id:"company_name",name:"company_name",placeholder:"Mi Empresa SA",required:!0})]),el("div",{style:{marginBottom:"var(--space-4)"}},[el("label",{for:"email"},"Email"),el("input",{type:"email",id:"email",name:"email",placeholder:"tu@email.com",required:!0,autocomplete:"email"})]),el("div",{style:{marginBottom:"var(--space-4)"}},[el("label",{for:"password"},"Contrase√±a"),el("input",{type:"password",id:"password",name:"password",placeholder:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢",required:!0,autocomplete:"new-password",minlength:"8"})]),el("div",{id:"errorMsg"}),el("button",{type:"submit"},"Crear Cuenta")]),el("div",{style:{marginTop:"var(--space-4)",textAlign:"center"}},[el("span",{style:{fontSize:"var(--font-sm)",color:"var(--color-gray-500)"}},"¬øYa tienes cuenta? "),el("span",{className:"link",onclick:()=>renderLogin()},"Inicia Sesi√≥n")])]);function o(){const e=document.getElementById("errorMsg");e.innerHTML="",t&&(e.className="error",e.textContent=t)}e.appendChild(r),o()}checkAuth().then((e=>{e||renderLogin()})).catch((()=>{console.error("Error cr√≠tico en checkAuth");authState={access:null,refresh:null,user:null};setStoredRefresh(null);renderLogin()}));</script></body></html>
