<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Login</title>
    <link rel="stylesheet" href="m.css" />
  </head>

  <body>
    <div id="app"></div>

    <script type="module">
      import { el } from "./mount.js";
      import { login, register, isAuthenticated } from "./auth.js";

      if (isAuthenticated()) {
        window.location.replace("dashboard.html");
      }

      let errorMsg = "";

      function renderLogin() {
        const app = document.getElementById("app");
        app.innerHTML = "";

        const container = el(
          "div",
          {
            style: {
              maxWidth: "400px",
              margin: "0 auto",
              padding: "var(--space-8)",
            },
          },
          [
            el(
              "h1",
              {
                style: {
                  textAlign: "center",
                  marginBottom: "var(--space-6)",
                },
              },
              "Iniciar Sesión"
            ),

            el(
              "form",
              {
                onsubmit: async (e) => {
                  e.preventDefault();

                  const form = new FormData(e.target);
                  const email = form.get("email");
                  const password = form.get("password");

                  try {
                    await login(email, password);
                    window.location.replace("dashboard.html");
                  } catch (err) {
                    errorMsg = err.message;
                    renderError();
                  }
                },
              },
              [
                el(
                  "div",
                  { style: { marginBottom: "var(--space-4)" } },
                  [
                    el("label", { for: "email" }, "Email"),
                    el("input", {
                      type: "email",
                      id: "email",
                      name: "email",
                      required: true,
                    }),
                  ]
                ),

                el(
                  "div",
                  { style: { marginBottom: "var(--space-4)" } },
                  [
                    el("label", { for: "password" }, "Contraseña"),
                    el("input", {
                      type: "password",
                      id: "password",
                      name: "password",
                      required: true,
                    }),
                  ]
                ),

                el("div", { id: "error" }),

                el("button", { type: "submit" }, "Entrar"),
              ]
            ),

            el(
              "p",
              {
                style: {
                  textAlign: "center",
                  marginTop: "var(--space-4)",
                },
              },
              [
                el(
                  "span",
                  {
                    className: "link",
                    onclick: () => renderRegister(),
                  },
                  "Crear cuenta"
                ),
              ]
            ),
          ]
        );

        function renderError() {
          const error = document.getElementById("error");
          if (errorMsg) {
            error.style.color = "#dc2626";
            error.style.marginBottom = "var(--space-4)";
            error.textContent = errorMsg;
          }
        }

        app.appendChild(container);
        renderError();
      }

      function renderRegister() {
        const app = document.getElementById("app");
        app.innerHTML = "";

        const container = el(
          "div",
          {
            style: {
              maxWidth: "400px",
              margin: "0 auto",
              padding: "var(--space-8)",
            },
          },
          [
            el(
              "h1",
              {
                style: {
                  textAlign: "center",
                  marginBottom: "var(--space-6)",
                },
              },
              "Crear Cuenta"
            ),

            el(
              "form",
              {
                onsubmit: async (e) => {
                  e.preventDefault();

                  const form = new FormData(e.target);
                  const email = form.get("email");
                  const password = form.get("password");
                  const company = form.get("company");

                  try {
                    await register(email, password, company);
                    await login(email, password);
                    window.location.replace("dashboard.html");
                  } catch (err) {
                    errorMsg = err.message;
                    renderError();
                  }
                },
              },
              [
                el(
                  "div",
                  { style: { marginBottom: "var(--space-4)" } },
                  [
                    el("label", { for: "company" }, "Nombre del Negocio"),
                    el("input", {
                      type: "text",
                      id: "company",
                      name: "company",
                      required: true,
                    }),
                  ]
                ),

                el(
                  "div",
                  { style: { marginBottom: "var(--space-4)" } },
                  [
                    el("label", { for: "email" }, "Email"),
                    el("input", {
                      type: "email",
                      id: "email",
                      name: "email",
                      required: true,
                    }),
                  ]
                ),

                el(
                  "div",
                  { style: { marginBottom: "var(--space-4)" } },
                  [
                    el("label", { for: "password" }, "Contraseña"),
                    el("input", {
                      type: "password",
                      id: "password",
                      name: "password",
                      minlength: "8",
                      required: true,
                    }),
                  ]
                ),

                el("div", { id: "error" }),

                el("button", { type: "submit" }, "Registrarse"),
              ]
            ),

            el(
              "p",
              {
                style: {
                  textAlign: "center",
                  marginTop: "var(--space-4)",
                },
              },
              [
                el(
                  "span",
                  {
                    className: "link",
                    onclick: () => renderLogin(),
                  },
                  "Ya tengo cuenta"
                ),
              ]
            ),
          ]
        );

        function renderError() {
          const error = document.getElementById("error");
          if (errorMsg) {
            error.style.color = "#dc2626";
            error.style.marginBottom = "var(--space-4)";
            error.textContent = errorMsg;
          }
        }

        app.appendChild(container);
        renderError();
      }

      renderLogin();
    </script>
  </body>
</html>
