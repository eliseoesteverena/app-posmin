<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auth - Login</title>

    <link rel="stylesheet" href="m.css" />

    <style>
        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error {
            color: #dc2626;
            font-size: var(--font-sm);
            margin-top: var(--space-1);
        }

        .link {
            color: var(--color-primary);
            cursor: pointer;
            font-size: var(--font-sm);
            text-decoration: underline;
        }

        .link:hover {
            color: var(--color-primary-dark);
        }
    </style>
</head>

<body>
    <div id="app"></div>
    <script type="module">
import { el } from "./mount.js";

// Configuración de la API Base URL
const API_BASE = window.location.hostname.includes("localhost")
  ? "http://localhost:8787"
  : "https://posmin-auth-service.eliseo050595.workers.dev";

// Estado de autenticación en memoria
let authState = {
  access: null,
  refresh: null,
  user: null
};

// ============================================================================
// GESTIÓN DE REFRESH TOKEN EN LOCALSTORAGE
// ============================================================================

function getStoredRefresh() {
  return localStorage.getItem("refresh_token");
}

function setStoredRefresh(token) {
  if (token) {
    localStorage.setItem("refresh_token", token);
  } else {
    localStorage.removeItem("refresh_token");
  }
}

// ============================================================================
// FUNCIÓN GENÉRICA PARA LLAMADAS A LA API
// ============================================================================

async function apiCall(endpoint, method = "GET", body = null) {
  const options = {
    method,
    headers: {
      "Content-Type": "application/json"
    }
  };

  // Agregar Authorization header si hay access token
  if (authState.access) {
    options.headers.Authorization = `Bearer ${authState.access}`;
  }

  if (body) {
    options.body = JSON.stringify(body);
  }

  const response = await fetch(`${API_BASE}${endpoint}`, options);

  if (!response.ok) {
    const error = await response.json().catch(() => ({
      error: "Error desconocido"
    }));
    throw new Error(error.error || error.message || "Error en la petición");
  }

  return response.json();
}

// ============================================================================
// AUTENTICACIÓN - ADAPTADO A NUEVA API
// ============================================================================

/**
 * Registrar nuevo usuario y negocio (tenant)
 * Endpoint: POST /register
 * 
 * MODO 1: Self-Registration (crear nueva cuenta/tenant)
 * Request:
 * {
 *   "email": "owner@nuevonegocio.com",
 *   "password": "SecurePass123!",
 *   "company_name": "Mi Nuevo Negocio"
 * }
 * 
 * Response 201:
 * {
 *   "id": "user-123",
 *   "email": "owner@nuevonegocio.com",
 *   "role": "owner",
 *   "tenant_id": "1707264123456-abc123",
 *   "tenant_name": "Mi Nuevo Negocio",
 *   "message": "User registered successfully"
 * }
 * 
 * IMPORTANTE: El registro NO retorna tokens. Debes hacer login después.
 */
async function register(email, password, companyName) {
  const data = await apiCall("/register", "POST", {
    email,
    password,
    company_name: companyName
  });

  // El endpoint de registro NO retorna tokens
  // Solo retorna información del usuario creado
  return data;
}

/**
 * Iniciar sesión
 * Endpoint: POST /login
 * 
 * Request:
 * {
 *   "email": "user@example.com",
 *   "password": "password123"
 * }
 * 
 * Response:
 * {
 *   "access_token": "eyJhbGc...",
 *   "refresh_token": "a1b2c3d4...",
 *   "user": { id, email, nombre, tenant_id, role },
 *   "expires_in": 28800
 * }
 */
async function login(email, password) {
  const data = await apiCall("/login", "POST", {
    email,
    password
  });

  // Actualizar estado global con los tokens y datos del usuario
  authState = {
    access: data.access_token,
    refresh: data.refresh_token,
    user: data.user
  };

  // Guardar refresh token en localStorage
  setStoredRefresh(data.refresh_token);

  return data;
}

/**
 * Refrescar access token usando refresh token
 * Endpoint: POST /refresh
 * 
 * IMPORTANTE: Con la nueva API, cada refresh genera un NUEVO refresh token
 * (Refresh Token Rotation). Debes actualizar AMBOS tokens.
 * 
 * Request:
 * {
 *   "refresh_token": "a1b2c3d4..."
 * }
 * 
 * Response:
 * {
 *   "access_token": "eyJhbGc... (NUEVO)",
 *   "refresh_token": "x1y2z3... (NUEVO - diferente al enviado)",
 *   "user": { id, email, nombre, tenant_id, role },
 *   "expires_in": 28800
 * }
 */
async function refreshToken() {
  const refresh = getStoredRefresh();
  
  if (!refresh) {
    throw new Error("No hay refresh token");
  }

  const data = await apiCall("/refresh", "POST", {
    refresh_token: refresh
  });

  // CRÍTICO: Actualizar AMBOS tokens
  // El viejo refresh token ya NO es válido (fue revocado automáticamente)
  authState.access = data.access_token;
  authState.refresh = data.refresh_token;
  authState.user = data.user; // Actualizar datos del usuario también

  // Guardar el NUEVO refresh token
  setStoredRefresh(data.refresh_token);

  return data;
}

/**
 * Cerrar sesión
 * Endpoint: POST /logout
 * 
 * Revoca la sesión actual en el servidor
 */
async function logout() {
  try {
    await apiCall("/logout", "POST");
  } catch (err) {
    console.error("Error al hacer logout en servidor:", err);
  } finally {
    authState = { access: null, refresh: null, user: null };
    setStoredRefresh(null);
    window.location.replace("index.html"); // ← replace, no href
  }
}

// ============================================================================
// INICIALIZACIÓN Y VERIFICACIÓN DE AUTENTICACIÓN
// ============================================================================

/**
 * Verificar si hay una sesión activa al cargar la página
 * Si hay refresh token, intenta renovar el access token
 */
async function checkAuth() {
  const refresh = getStoredRefresh();
  if (!refresh) return false; // sin sesión, mostrar login

  try {
    await refreshToken();
    window.location.replace("dashboard.html"); // replace = sin historial
    return true; // hay sesión activa, NO mostrar login
  } catch (err) {
    console.error("Error al verificar autenticación:", err);
    authState = { access: null, refresh: null, user: null };
    setStoredRefresh(null);
    return false;
  }
}
// ============================================================================
// INTERFAZ DE USUARIO - LOGIN
// ============================================================================

function renderLogin() {
  const app = document.getElementById("app");
  app.innerHTML = "";
  let error = "";

  const container = el(
    "div",
    {
      style: {
        backgroundColor: "var(--color-white)",
        padding: "var(--space-8)",
        borderRadius: "var(--radius-lg)",
        boxShadow: "0 4px 6px rgba(0,0,0,0.1)",
        maxWidth: "400px",
        width: "100%"
      }
    },
    [
      el(
        "h1",
        {
          style: {
            fontSize: "var(--font-3xl)",
            fontWeight: "700",
            marginBottom: "var(--space-2)",
            textAlign: "center",
            color: "var(--color-primary)"
          }
        },
        "Iniciar Sesión"
      ),
      el(
        "p",
        {
          style: {
            textAlign: "center",
            color: "var(--color-gray-500)",
            marginBottom: "var(--space-6)",
            fontSize: "var(--font-sm)"
          }
        },
        "Accede a tu cuenta"
      ),
      el(
        "form",
        {
          id: "loginForm",
          onsubmit: async e => {
            e.preventDefault();
            const form = new FormData(e.target);
            const email = form.get("email");
            const password = form.get("password");

            if (!email || !password) {
              error = "Email y contraseña son requeridos";
              updateError();
              return;
            }

            const button = document.querySelector("button[type=submit]");
            button.disabled = true;
            button.textContent = "Iniciando...";

            try {
              await login(email, password);
              window.location.href = "dashboard.html";
            } catch (err) {
              error = err.message;
              updateError();
              button.disabled = false;
              button.textContent = "Iniciar Sesión";
            }
          }
        },
        [
          el(
            "div",
            {
              style: {
                marginBottom: "var(--space-4)"
              }
            },
            [
              el("label", { for: "email" }, "Email"),
              el("input", {
                type: "email",
                id: "email",
                name: "email",
                placeholder: "tu@email.com",
                required: true,
                autocomplete: "email"
              })
            ]
          ),
          el(
            "div",
            {
              style: {
                marginBottom: "var(--space-4)"
              }
            },
            [
              el("label", { for: "password" }, "Contraseña"),
              el("input", {
                type: "password",
                id: "password",
                name: "password",
                placeholder: "••••••••",
                required: true,
                autocomplete: "current-password"
              })
            ]
          ),
          el("div", { id: "errorMsg" }),
          el("button", { type: "submit" }, "Iniciar Sesión")
        ]
      ),
      el(
        "div",
        {
          style: {
            marginTop: "var(--space-4)",
            textAlign: "center"
          }
        },
        [
          el(
            "span",
            {
              style: {
                fontSize: "var(--font-sm)",
                color: "var(--color-gray-500)"
              }
            },
            "¿No tienes cuenta? "
          ),
          el(
            "span",
            {
              className: "link",
              onclick: () => renderRegister()
            },
            "Regístrate"
          )
        ]
      )
    ]
  );

  function updateError() {
    const box = document.getElementById("errorMsg");
    box.innerHTML = "";
    if (error) {
      box.className = "error";
      box.textContent = error;
    }
  }

  app.appendChild(container);
  updateError();
}

// ============================================================================
// INTERFAZ DE USUARIO - REGISTRO
// ============================================================================

function renderRegister() {
  const app = document.getElementById("app");
  app.innerHTML = "";
  let error = "";

  const container = el(
    "div",
    {
      style: {
        backgroundColor: "var(--color-white)",
        padding: "var(--space-8)",
        borderRadius: "var(--radius-lg)",
        boxShadow: "0 4px 6px rgba(0,0,0,0.1)",
        maxWidth: "400px",
        width: "100%"
      }
    },
    [
      el(
        "h1",
        {
          style: {
            fontSize: "var(--font-3xl)",
            fontWeight: "700",
            marginBottom: "var(--space-2)",
            textAlign: "center",
            color: "var(--color-primary)"
          }
        },
        "Crear Cuenta"
      ),
      el(
        "p",
        {
          style: {
            textAlign: "center",
            color: "var(--color-gray-500)",
            marginBottom: "var(--space-6)",
            fontSize: "var(--font-sm)"
          }
        },
        "Regístrate para comenzar"
      ),
      el(
        "form",
        {
          id: "registerForm",
          onsubmit: async e => {
            e.preventDefault();
            const form = new FormData(e.target);
            const email = form.get("email");
            const password = form.get("password");
            const companyName = form.get("company_name");

            if (!email || !password || !companyName) {
              error = "Todos los campos son requeridos";
              updateError();
              return;
            }

            if (password.length < 8) {
              error = "La contraseña debe tener al menos 8 caracteres";
              updateError();
              return;
            }

            const button = document.querySelector("button[type=submit]");
            button.disabled = true;
            button.textContent = "Registrando...";

            try {
              // Registrar usuario (no retorna tokens)
              await register(email, password, companyName);
              
              // Hacer login automáticamente después del registro
              button.textContent = "Iniciando sesión...";
              await login(email, password);
              
              // Redirigir al dashboard
              window.location.href = "dashboard.html";
            } catch (err) {
              error = err.message;
              updateError();
              button.disabled = false;
              button.textContent = "Crear Cuenta";
            }
          }
        },
        [
          el(
            "div",
            {
              style: {
                marginBottom: "var(--space-4)"
              }
            },
            [
              el("label", { for: "company_name" }, "Nombre del Negocio"),
              el("input", {
                type: "text",
                id: "company_name",
                name: "company_name",
                placeholder: "Mi Empresa SA",
                required: true
              })
            ]
          ),
          el(
            "div",
            {
              style: {
                marginBottom: "var(--space-4)"
              }
            },
            [
              el("label", { for: "email" }, "Email"),
              el("input", {
                type: "email",
                id: "email",
                name: "email",
                placeholder: "tu@email.com",
                required: true,
                autocomplete: "email"
              })
            ]
          ),
          el(
            "div",
            {
              style: {
                marginBottom: "var(--space-4)"
              }
            },
            [
              el("label", { for: "password" }, "Contraseña"),
              el("input", {
                type: "password",
                id: "password",
                name: "password",
                placeholder: "••••••••",
                required: true,
                autocomplete: "new-password",
                minlength: "8"
              })
            ]
          ),
          el("div", { id: "errorMsg" }),
          el("button", { type: "submit" }, "Crear Cuenta")
        ]
      ),
      el(
        "div",
        {
          style: {
            marginTop: "var(--space-4)",
            textAlign: "center"
          }
        },
        [
          el(
            "span",
            {
              style: {
                fontSize: "var(--font-sm)",
                color: "var(--color-gray-500)"
              }
            },
            "¿Ya tienes cuenta? "
          ),
          el(
            "span",
            {
              className: "link",
              onclick: () => renderLogin()
            },
            "Inicia Sesión"
          )
        ]
      )
    ]
  );

  function updateError() {
    const box = document.getElementById("errorMsg");
    box.innerHTML = "";
    if (error) {
      box.className = "error";
      box.textContent = error;
    }
  }

  app.appendChild(container);
  updateError();
}

// ============================================================================
// INICIALIZACIÓN DE LA APLICACIÓN
// ============================================================================

checkAuth().then(isAuthenticated => {
  if (!isAuthenticated) renderLogin();
});
</script>

</body>
</html>