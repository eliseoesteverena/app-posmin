<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Dashboard</title><link rel="stylesheet" href="m.css"></head><body><div id="app"></div><script type="module">import{el}from'./mount.js';const API_BASE=window.location.hostname.includes("localhost")?"http://localhost:8787":"https://posmin-auth-service.eliseo050595.workers.dev";let authState={access:null,refresh:null,user:null};function getStoredRefresh(){return localStorage.getItem("refresh_token")}function setStoredRefresh(e){e?localStorage.setItem("refresh_token",e):localStorage.removeItem("refresh_token")}async function apiCall(e,t="GET",r=null){const a={method:t,headers:{"Content-Type":"application/json"}};authState.access&&(a.headers.Authorization=`Bearer ${authState.access}`),r&&(a.body=JSON.stringify(r));const s=await fetch(`${API_BASE}${e}`,a);if(401===s.status&&"/refresh"!==e)try{await refreshToken();const s=await fetch(`${API_BASE}${e}`,{...a,headers:{...a.headers,Authorization:`Bearer ${authState.access}`}});if(!s.ok){const e=await s.json().catch((()=>({error:"Error desconocido"})));throw new Error(e.error||e.message||"Error en la petici√≥n")}return s.json()}catch(e){return logout(),null}if(!s.ok){const e=await s.json().catch((()=>({error:"Error desconocido"})));throw new Error(e.error||e.message||"Error en la petici√≥n")}return s.json()}async function refreshToken(){const e=getStoredRefresh();if(!e)throw new Error("No hay refresh token");console.log("üîÑ Refrescando token...");const t=await apiCall("/refresh","POST",{refresh_token:e});console.log("‚úÖ Token refrescado");authState.access=t.access_token;authState.refresh=t.refresh_token;setStoredRefresh(t.refresh_token);return t}async function logout(){try{await apiCall("/logout","POST")}catch(e){console.error("Error al hacer logout:",e)}finally{authState={access:null,refresh:null,user:null},setStoredRefresh(null),window.location.replace("index.html")}}async function initAuth(){const e=getStoredRefresh();if(!e){console.log("‚ùå No hay refresh token en dashboard");window.location.replace("index.html");return}try{console.log("üîÑ Intentando refresh token...");const e=await refreshToken();console.log("‚úÖ Refresh exitoso:",e);authState.user=e.user||{email:"usuario@example.com"};renderDashboard();startTokenRefresh()}catch(t){console.error("‚ùå Error en initAuth:",t);setStoredRefresh(null);authState={access:null,refresh:null,user:null};window.location.replace("index.html")}}function renderDashboard(){const e=document.getElementById("app");e.innerHTML="";const t=el("div",{style:{minHeight:"100vh"}},[el("nav",{style:{backgroundColor:"var(--color-primary)",padding:"var(--space-4)",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"}},[el("div",{style:{maxWidth:"1200px",margin:"0 auto",display:"flex",justifyContent:"space-between",alignItems:"center"}},[el("h1",{style:{color:"var(--color-white)",fontSize:"var(--font-2xl)",fontWeight:"700",margin:"0"}},"Dashboard"),el("button",{onclick:()=>logout(),style:{backgroundColor:"var(--color-primary-dark)"}},"Cerrar Sesi√≥n")])]),el("main",{style:{maxWidth:"1200px",margin:"var(--space-8) auto",padding:"0 var(--space-4)"}},[el("div",{style:{backgroundColor:"var(--color-white)",padding:"var(--space-8)",borderRadius:"var(--radius-lg)",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"}},[el("h2",{style:{fontSize:"var(--font-3xl)",fontWeight:"700",marginBottom:"var(--space-4)",color:"var(--color-primary)"}},"Bienvenido"),el("div",{style:{backgroundColor:"var(--color-primary-light)",padding:"var(--space-6)",borderRadius:"var(--radius-md)",marginBottom:"var(--space-6)"}},[el("p",{style:{fontSize:"var(--font-lg)",color:"var(--color-gray-700)",marginBottom:"var(--space-2)"}},[el("strong",{},"Email: "),authState.user?.email||"Cargando..."]),el("p",{style:{fontSize:"var(--font-base)",color:"var(--color-gray-500)"}},"Autenticaci√≥n exitosa con refresh token autom√°tico")]),el("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(250px, 1fr))",gap:"var(--space-4)"}},[buildFeature("‚úì Login","Sistema de autenticaci√≥n completo"),buildFeature("‚úì Registro","Creaci√≥n de nuevas cuentas"),buildFeature("‚úì Refresh","Renovaci√≥n autom√°tica de tokens")])])])]);e.appendChild(t)}function buildFeature(e,t){return el("div",{style:{backgroundColor:"var(--color-gray-50)",padding:"var(--space-6)",borderRadius:"var(--radius-md)",border:"1px solid var(--color-gray-200)"}},[el("h3",{style:{fontSize:"var(--font-xl)",fontWeight:"600",marginBottom:"var(--space-2)",color:"var(--color-primary)"}},e),el("p",{style:{fontSize:"var(--font-sm)",color:"var(--color-gray-600)"}},t)])}let refreshInterval;async function startTokenRefresh(){refreshInterval&&clearInterval(refreshInterval),refreshInterval=setInterval((async()=>{try{await refreshToken(),console.log("Token renovado autom√°ticamente")}catch(e){console.error("Error al renovar token:",e),logout()}}),42e5)}initAuth();</script></body></html>
