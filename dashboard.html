<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="m.css" />
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      import { el } from "./mount.js";

      const API_BASE = window.location.hostname.includes("localhost")
        ? "http://localhost:8787"
        : "https://posmin-auth-service.eliseo050595.workers.dev";

      let authState = {
        access: null,
        refresh: null,
        user: null,
      };

      function getStoredRefresh() {
        return localStorage.getItem("refresh_token");
      }

      function setStoredRefresh(token) {
        token
          ? localStorage.setItem("refresh_token", token)
          : localStorage.removeItem("refresh_token");
      }

      async function apiCall(endpoint, method = "GET", body = null) {
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
          },
        };

        if (authState.access) {
          options.headers.Authorization = `Bearer ${authState.access}`;
        }

        if (body) {
          options.body = JSON.stringify(body);
        }

        const response = await fetch(`${API_BASE}${endpoint}`, options);

        if (response.status === 401 && endpoint !== "/refresh") {
          try {
            await refreshToken();

            const retryResponse = await fetch(`${API_BASE}${endpoint}`, {
              ...options,
              headers: {
                ...options.headers,
                Authorization: `Bearer ${authState.access}`,
              },
            });

            if (!retryResponse.ok) {
              const errorData = await retryResponse
                .json()
                .catch(() => ({ error: "Error desconocido" }));
              throw new Error(
                errorData.error ||
                  errorData.message ||
                  "Error en la petici√≥n"
              );
            }

            return retryResponse.json();
          } catch (error) {
            logout();
            return null;
          }
        }

        if (!response.ok) {
          const errorData = await response
            .json()
            .catch(() => ({ error: "Error desconocido" }));
          throw new Error(
            errorData.error || errorData.message || "Error en la petici√≥n"
          );
        }

        return response.json();
      }

      async function refreshToken() {
        const storedRefresh = getStoredRefresh();
        if (!storedRefresh) {
          throw new Error("No hay refresh token");
        }

        console.log("üîÑ Refrescando token...");

        const data = await apiCall("/refresh", "POST", {
          refresh_token: storedRefresh,
        });

        console.log("‚úÖ Token refrescado");

        authState.access = data.accessToken;
        authState.refresh = data.refreshToken;
        setStoredRefresh(data.refreshToken);

        return data;
      }

      async function logout() {
        try {
          await apiCall("/logout", "POST");
        } catch (error) {
          console.error("Error al hacer logout:", error);
        } finally {
          authState = { access: null, refresh: null, user: null };
          setStoredRefresh(null);
          window.location.replace("index.html");
        }
      }

      async function initAuth() {
        console.log("üì± Dashboard cargado");
        console.log("üîç Buscando refresh token en localStorage...");

        const storedRefresh = getStoredRefresh();

        console.log(
          "üîç Refresh token encontrado:",
          storedRefresh
            ? `S√≠ (${storedRefresh.substring(0, 20)}...)`
            : "No"
        );

        if (!storedRefresh) {
          console.log("‚ùå No hay refresh token en dashboard");
          window.location.replace("index.html");
          return;
        }

        try {
          console.log("üîÑ Intentando refresh token...");
          const data = await refreshToken();
          console.log("‚úÖ Refresh exitoso:", data);

          authState.user = data.user || { email: "usuario@example.com" };

          renderDashboard();
          startTokenRefresh();
        } catch (error) {
          console.error("‚ùå Error en initAuth:", error);
          setStoredRefresh(null);
          authState = { access: null, refresh: null, user: null };
          window.location.replace("index.html");
        }
      }

      function renderDashboard() {
        const app = document.getElementById("app");
        app.innerHTML = "";

        const layout = el("div", { style: { minHeight: "100vh" } }, [
          el(
            "nav",
            {
              style: {
                backgroundColor: "var(--color-primary)",
                padding: "var(--space-4)",
                boxShadow: "0 2px 4px rgba(0,0,0,0.1)",
              },
            },
            [
              el(
                "div",
                {
                  style: {
                    maxWidth: "1200px",
                    margin: "0 auto",
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                  },
                },
                [
                  el(
                    "h1",
                    {
                      style: {
                        color: "var(--color-white)",
                        fontSize: "var(--font-2xl)",
                        fontWeight: "700",
                        margin: "0",
                      },
                    },
                    "Dashboard"
                  ),
                  el(
                    "button",
                    {
                      onclick: () => logout(),
                      style: {
                        backgroundColor: "var(--color-primary-dark)",
                      },
                    },
                    "Cerrar Sesi√≥n"
                  ),
                ]
              ),
            ]
          ),
          el(
            "main",
            {
              style: {
                maxWidth: "1200px",
                margin: "var(--space-8) auto",
                padding: "0 var(--space-4)",
              },
            },
            [
              el(
                "div",
                {
                  style: {
                    backgroundColor: "var(--color-white)",
                    padding: "var(--space-8)",
                    borderRadius: "var(--radius-lg)",
                    boxShadow: "0 2px 4px rgba(0,0,0,0.1)",
                  },
                },
                [
                  el(
                    "h2",
                    {
                      style: {
                        fontSize: "var(--font-3xl)",
                        fontWeight: "700",
                        marginBottom: "var(--space-4)",
                        color: "var(--color-primary)",
                      },
                    },
                    "Bienvenido"
                  ),
                  el(
                    "div",
                    {
                      style: {
                        backgroundColor: "var(--color-primary-light)",
                        padding: "var(--space-6)",
                        borderRadius: "var(--radius-md)",
                        marginBottom: "var(--space-6)",
                      },
                    },
                    [
                      el(
                        "p",
                        {
                          style: {
                            fontSize: "var(--font-lg)",
                            color: "var(--color-gray-700)",
                            marginBottom: "var(--space-2)",
                          },
                        },
                        [
                          el("strong", {}, "Email: "),
                          authState.user?.email || "Cargando...",
                        ]
                      ),
                      el(
                        "p",
                        {
                          style: {
                            fontSize: "var(--font-base)",
                            color: "var(--color-gray-500)",
                          },
                        },
                        "Autenticaci√≥n exitosa con refresh token autom√°tico"
                      ),
                    ]
                  ),
                  el(
                    "div",
                    {
                      style: {
                        display: "grid",
                        gridTemplateColumns:
                          "repeat(auto-fit, minmax(250px, 1fr))",
                        gap: "var(--space-4)",
                      },
                    },
                    [
                      buildFeature(
                        "‚úì Login",
                        "Sistema de autenticaci√≥n completo"
                      ),
                      buildFeature(
                        "‚úì Registro",
                        "Creaci√≥n de nuevas cuentas"
                      ),
                      buildFeature(
                        "‚úì Refresh",
                        "Renovaci√≥n autom√°tica de tokens"
                      ),
                    ]
                  ),
                ]
              ),
            ]
          ),
        ]);

        app.appendChild(layout);
      }

      function buildFeature(title, description) {
        return el(
          "div",
          {
            style: {
              backgroundColor: "var(--color-gray-50)",
              padding: "var(--space-6)",
              borderRadius: "var(--radius-md)",
              border: "1px solid var(--color-gray-200)",
            },
          },
          [
            el(
              "h3",
              {
                style: {
                  fontSize: "var(--font-xl)",
                  fontWeight: "600",
                  marginBottom: "var(--space-2)",
                  color: "var(--color-primary)",
                },
              },
              title
            ),
            el(
              "p",
              {
                style: {
                  fontSize: "var(--font-sm)",
                  color: "var(--color-gray-600)",
                },
              },
              description
            ),
          ]
        );
      }

      let refreshInterval;

      async function startTokenRefresh() {
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }

        refreshInterval = setInterval(async () => {
          try {
            await refreshToken();
            console.log("Token renovado autom√°ticamente");
          } catch (error) {
            console.error("Error al renovar token:", error);
            logout();
          }
        }, 42e5);
      }

      initAuth();
    </script>
  </body>
</html>