<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="m.css" />
  </head>

  <body>
    <div id="app"></div>

    <script type="module">
      import { el } from "./mount.js";
      import {
        initAuth,
        requireAuth,
        logout,
        getUser,
        apiRequest,
      } from "./auth.js";

      requireAuth();

      let productos = [];

      async function cargarProductos() {
        try {
          const res = await apiRequest("/api/products");
          productos = res.productos || res.data || [];
        } catch (error) {
          console.error("Error:", error);
        }
      }

      function render() {
        const user = getUser();
        const app = document.getElementById("app");
        app.innerHTML = "";

        const container = el("div", {}, [
          el(
            "nav",
            {
              style: {
                backgroundColor: "var(--color-primary)",
                padding: "var(--space-4)",
                marginBottom: "var(--space-6)",
              },
            },
            [
              el(
                "div",
                {
                  className: "container",
                  style: {
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                  },
                },
                [
                  el(
                    "h1",
                    {
                      style: {
                        color: "white",
                        margin: "0",
                      },
                    },
                    "Mi App"
                  ),

                  el(
                    "div",
                    {
                      style: {
                        display: "flex",
                        gap: "var(--space-4)",
                        alignItems: "center",
                      },
                    },
                    [
                      el(
                        "span",
                        { style: { color: "white" } },
                        user?.email || "Usuario"
                      ),

                      el(
                        "button",
                        {
                          onclick: () => logout(),
                          style: {
                            backgroundColor: "var(--color-primary-dark)",
                          },
                        },
                        "Salir"
                      ),
                    ]
                  ),
                ]
              ),
            ]
          ),

          el("main", { className: "container" }, [
            el(
              "h2",
              { style: { marginBottom: "var(--space-4)" } },
              "Dashboard"
            ),

            el("p", {}, "Bienvenido al sistema"),

            el(
              "div",
              { style: { marginTop: "var(--space-6)" } },
              [
                el("h3", {}, "Productos"),

                productos.length > 0
                  ? el(
                      "ul",
                      {},
                      productos.map((p) => el("li", {}, p.nombre))
                    )
                  : el("p", {}, "No hay productos"),
              ]
            ),
          ]),
        ]);

        app.appendChild(container);
      }

      initAuth()
        .then(() => {
          cargarProductos().then(() => render());
        })
        .catch(() => {
          window.location.replace("index.html");
        });
    </script>
  </body>
</html>
