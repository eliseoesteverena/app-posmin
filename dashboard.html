<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auth - Login</title>
    <link rel="stylesheet" href="m.css" />
    <style>
      body {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .error {
        color: #dc2626;
        font-size: var(--font-sm);
        margin-top: var(--space-1);
      }

      .link {
        color: var(--color-primary);
        cursor: pointer;
        font-size: var(--font-sm);
        text-decoration: underline;
      }

      .link:hover {
        color: var(--color-primary-dark);
      }
    </style>
  </head>

  <body>
    <div id="app"></div>

    <script type="module">
      import { el } from "./mount.js";

      const API_BASE = window.location.hostname.includes("localhost")
        ? "http://localhost:8787"
        : "https://posmin-auth-service.eliseo050595.workers.dev";

      let authState = {
        access: null,
        refresh: null,
        user: null,
      };

      function getStoredRefresh() {
        return localStorage.getItem("refresh_token");
      }

      function setStoredRefresh(token) {
        token
          ? localStorage.setItem("refresh_token", token)
          : localStorage.removeItem("refresh_token");
      }

      async function apiCall(endpoint, method = "GET", body = null) {
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
          },
        };

        if (authState.access) {
          options.headers.Authorization = `Bearer ${authState.access}`;
        }

        if (body) {
          options.body = JSON.stringify(body);
        }

        const response = await fetch(`${API_BASE}${endpoint}`, options);

        if (!response.ok) {
          const error = await response
            .json()
            .catch(() => ({ error: "Error desconocido" }));

          throw new Error(
            error.error || error.message || "Error en la petici√≥n"
          );
        }

        return response.json();
      }

      async function register(email, password, companyName) {
        return await apiCall("/register", "POST", {
          email,
          password,
          company_name: companyName,
        });
      }

      async function login(email, password) {
        console.log("üîê Intentando login...");

        const data = await apiCall("/login", "POST", {
          email,
          password,
        });

        console.log("‚úÖ Login exitoso:", data);
        console.log("üì¶ Datos completos:", JSON.stringify(data, null, 2));
        console.log("üîë Access token:", data.access_token);
        console.log("üîÑ Refresh token:", data.refresh_token);

        authState = {
          access: data.access_token,
          refresh: data.refresh_token,
          user: data.user,
        };

        setStoredRefresh(data.refresh_token);

        console.log(
          "üíæ Refresh token guardado:",
          localStorage.getItem("refresh_token")
        );

        await new Promise((resolve) => setTimeout(resolve, 100));

        console.log(
          "‚úÖ Verificando storage:",
          localStorage.getItem("refresh_token")
        );

        return data;
      }

      async function refreshToken() {
        const refresh = getStoredRefresh();
        if (!refresh) throw new Error("No hay refresh token");

        console.log("üîÑ Refrescando token...");

        const data = await apiCall("/refresh", "POST", {
          refresh_token: refresh,
        });

        console.log("‚úÖ Token refrescado");

        authState.access = data.access_token;
        authState.refresh = data.refresh_token;

        setStoredRefresh(data.refresh_token);

        return data;
      }

      async function logout() {
        try {
          await apiCall("/logout", "POST");
        } catch (err) {
          console.error("Error al hacer logout:", err);
        } finally {
          authState = { access: null, refresh: null, user: null };
          setStoredRefresh(null);
          window.location.replace("index.html");
        }
      }

      async function checkAuth() {
        const refresh = getStoredRefresh();
        if (!refresh) return false;

        try {
          await refreshToken();
          console.log("‚úÖ Auth v√°lida, redirigiendo a dashboard");
          window.location.replace("dashboard.html");
          return true;
        } catch (err) {
          console.error("‚ùå Error en checkAuth:", err);
          authState = { access: null, refresh: null, user: null };
          setStoredRefresh(null);
          return false;
        }
      }

      function renderLogin() {
        const app = document.getElementById("app");
        app.innerHTML = "";

        let errorMessage = "";

        const card = el(
          "div",
          {
            style: {
              backgroundColor: "var(--color-white)",
              padding: "var(--space-8)",
              borderRadius: "var(--radius-lg)",
              boxShadow: "0 4px 6px rgba(0,0,0,0.1)",
              maxWidth: "400px",
              width: "100%",
            },
          },
          [
            el(
              "h1",
              {
                style: {
                  fontSize: "var(--font-3xl)",
                  fontWeight: "700",
                  marginBottom: "var(--space-2)",
                  textAlign: "center",
                  color: "var(--color-primary)",
                },
              },
              "Iniciar Sesi√≥n"
            ),
            el(
              "p",
              {
                style: {
                  textAlign: "center",
                  color: "var(--color-gray-500)",
                  marginBottom: "var(--space-6)",
                  fontSize: "var(--font-sm)",
                },
              },
              "Accede a tu cuenta"
            ),
            el(
              "form",
              {
                id: "loginForm",
                onsubmit: async (event) => {
                  event.preventDefault();

                  const formData = new FormData(event.target);
                  const email = formData.get("email");
                  const password = formData.get("password");

                  if (!email || !password) {
                    errorMessage =
                      "Email y contrase√±a son requeridos";
                    updateError();
                    return;
                  }

                  const button =
                    document.querySelector("button[type=submit]");
                  button.disabled = true;
                  button.textContent = "Iniciando...";

                  try {
                    await login(email, password);

                    console.log(
                      "üöÄ Redirigiendo a dashboard..."
                    );

                    await new Promise((resolve) =>
                      setTimeout(resolve, 100)
                    );

                    window.location.replace(
                      "dashboard.html"
                    );
                  } catch (err) {
                    errorMessage = err.message;
                    updateError();
                    button.disabled = false;
                    button.textContent = "Iniciar Sesi√≥n";
                  }
                },
              },
              [
                el(
                  "div",
                  { style: { marginBottom: "var(--space-4)" } },
                  [
                    el("label", { for: "email" }, "Email"),
                    el("input", {
                      type: "email",
                      id: "email",
                      name: "email",
                      placeholder: "tu@email.com",
                      required: true,
                      autocomplete: "email",
                    }),
                  ]
                ),
                el(
                  "div",
                  { style: { marginBottom: "var(--space-4)" } },
                  [
                    el("label", { for: "password" }, "Contrase√±a"),
                    el("input", {
                      type: "password",
                      id: "password",
                      name: "password",
                      placeholder: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢",
                      required: true,
                      autocomplete: "current-password",
                    }),
                  ]
                ),
                el("div", { id: "errorMsg" }),
                el(
                  "button",
                  { type: "submit" },
                  "Iniciar Sesi√≥n"
                ),
              ]
            ),
            el(
              "div",
              {
                style: {
                  marginTop: "var(--space-4)",
                  textAlign: "center",
                },
              },
              [
                el(
                  "span",
                  {
                    style: {
                      fontSize: "var(--font-sm)",
                      color: "var(--color-gray-500)",
                    },
                  },
                  "¬øNo tienes cuenta? "
                ),
                el(
                  "span",
                  {
                    className: "link",
                    onclick: () => renderRegister(),
                  },
                  "Reg√≠strate"
                ),
              ]
            ),
          ]
        );

        function updateError() {
          const container =
            document.getElementById("errorMsg");
          container.innerHTML = "";

          if (errorMessage) {
            container.className = "error";
            container.textContent = errorMessage;
          }
        }

        app.appendChild(card);
        updateError();
      }

      function renderRegister() {
        const app = document.getElementById("app");
        app.innerHTML = "";

        let errorMessage = "";

        const card = el(
          "div",
          {
            style: {
              backgroundColor: "var(--color-white)",
              padding: "var(--space-8)",
              borderRadius: "var(--radius-lg)",
              boxShadow: "0 4px 6px rgba(0,0,0,0.1)",
              maxWidth: "400px",
              width: "100%",
            },
          },
          [
            el(
              "h1",
              {
                style: {
                  fontSize: "var(--font-3xl)",
                  fontWeight: "700",
                  marginBottom: "var(--space-2)",
                  textAlign: "center",
                  color: "var(--color-primary)",
                },
              },
              "Crear Cuenta"
            ),
            el(
              "p",
              {
                style: {
                  textAlign: "center",
                  color: "var(--color-gray-500)",
                  marginBottom: "var(--space-6)",
                  fontSize: "var(--font-sm)",
                },
              },
              "Reg√≠strate para comenzar"
            ),
            el(
              "form",
              {
                id: "registerForm",
                onsubmit: async (event) => {
                  event.preventDefault();

                  const formData = new FormData(event.target);
                  const email = formData.get("email");
                  const password =
                    formData.get("password");
                  const companyName =
                    formData.get("company_name");

                  if (!email || !password || !companyName) {
                    errorMessage =
                      "Todos los campos son requeridos";
                    updateError();
                    return;
                  }

                  if (password.length < 8) {
                    errorMessage =
                      "La contrase√±a debe tener al menos 8 caracteres";
                    updateError();
                    return;
                  }

                  const button =
                    document.querySelector("button[type=submit]");
                  button.disabled = true;
                  button.textContent = "Registrando...";

                  try {
                    await register(
                      email,
                      password,
                      companyName
                    );

                    button.textContent =
                      "Iniciando sesi√≥n...";

                    await login(email, password);

                    console.log(
                      "üöÄ Redirigiendo a dashboard..."
                    );

                    await new Promise((resolve) =>
                      setTimeout(resolve, 100)
                    );

                    window.location.replace(
                      "dashboard.html"
                    );
                  } catch (err) {
                    errorMessage = err.message;
                    updateError();
                    button.disabled = false;
                    button.textContent = "Crear Cuenta";
                  }
                },
              },
              [
                el(
                  "div",
                  { style: { marginBottom: "var(--space-4)" } },
                  [
                    el(
                      "label",
                      { for: "company_name" },
                      "Nombre del Negocio"
                    ),
                    el("input", {
                      type: "text",
                      id: "company_name",
                      name: "company_name",
                      placeholder: "Mi Empresa SA",
                      required: true,
                    }),
                  ]
                ),
                el(
                  "div",
                  { style: { marginBottom: "var(--space-4)" } },
                  [
                    el("label", { for: "email" }, "Email"),
                    el("input", {
                      type: "email",
                      id: "email",
                      name: "email",
                      placeholder: "tu@email.com",
                      required: true,
                      autocomplete: "email",
                    }),
                  ]
                ),
                el(
                  "div",
                  { style: { marginBottom: "var(--space-4)" } },
                  [
                    el(
                      "label",
                      { for: "password" },
                      "Contrase√±a"
                    ),
                    el("input", {
                      type: "password",
                      id: "password",
                      name: "password",
                      placeholder: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢",
                      required: true,
                      autocomplete: "new-password",
                      minlength: "8",
                    }),
                  ]
                ),
                el("div", { id: "errorMsg" }),
                el(
                  "button",
                  { type: "submit" },
                  "Crear Cuenta"
                ),
              ]
            ),
            el(
              "div",
              {
                style: {
                  marginTop: "var(--space-4)",
                  textAlign: "center",
                },
              },
              [
                el(
                  "span",
                  {
                    style: {
                      fontSize: "var(--font-sm)",
                      color: "var(--color-gray-500)",
                    },
                  },
                  "¬øYa tienes cuenta? "
                ),
                el(
                  "span",
                  {
                    className: "link",
                    onclick: () => renderLogin(),
                  },
                  "Inicia Sesi√≥n"
                ),
              ]
            ),
          ]
        );

        function updateError() {
          const container =
            document.getElementById("errorMsg");
          container.innerHTML = "";

          if (errorMessage) {
            container.className = "error";
            container.textContent = errorMessage;
          }
        }

        app.appendChild(card);
        updateError();
      }

      checkAuth()
        .then((isValid) => {
          if (!isValid) renderLogin();
        })
        .catch(() => {
          console.error("Error cr√≠tico en checkAuth");
          authState = {
            access: null,
            refresh: null,
            user: null,
          };
          setStoredRefresh(null);
          renderLogin();
        });
    </script>
  </body>
</html>